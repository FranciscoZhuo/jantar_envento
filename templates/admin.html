<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
    <div class="card card-wide">
        <div class="icon">&#128203;</div>
        <h1>Admin Dashboard</h1>
        <p class="subtitle">Manage burger pickups</p>

        {% if message %}
        <div class="message {{ msg_class }}">{{ message }}</div>
        {% endif %}

        <!-- Stats (overview first) -->
        <div class="stats">
            <div class="stat-box">
                <div class="stat-num">{{ total }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-box">
                <div class="stat-num">{{ picked }}</div>
                <div class="stat-label">Picked up</div>
            </div>
            <div class="stat-box">
                <div class="stat-num">{{ remaining }}</div>
                <div class="stat-label">Remaining</div>
            </div>
        </div>

        <!-- Add new user -->
        <div class="add-form">
            <h2>Add User</h2>
            <form method="POST" class="inline-form">
                <input type="hidden" name="action" value="add">
                <input type="text" name="new_name" placeholder="Name" required>
                <input type="text" name="new_burger" placeholder="Burger" required>
                <button class="btn-small" type="submit">Add</button>
            </form>
        </div>

        <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Burger</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for row in rows %}
                <tr id="row-{{ row.id }}">
                    <td>{{ loop.index }}</td>

                    <!-- Inline edit form -->
                    <td>
                        <form method="POST" class="edit-form" id="edit-{{ row.id }}">
                            <input type="hidden" name="action" value="edit">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <input type="text" name="edit_name" value="{{ row.name }}" class="inline-input">
                    </td>
                    <td>
                            <input type="text" name="edit_burger" value="{{ row.burger }}" class="inline-input">
                        </form>
                    </td>

                    <td>
                        {% if row.received %}
                            <span class="status-yes">Picked up</span>
                        {% else %}
                            <span class="status-no">Waiting</span>
                        {% endif %}
                    </td>
                    <td class="action-cell">
                        <!-- Mark / Reset — primary action -->
                        {% if row.received %}
                        <form method="POST" class="inline-action">
                            <input type="hidden" name="action" value="reset">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <button class="btn-small btn-danger" type="submit">Reset</button>
                        </form>
                        {% else %}
                        <form method="POST" class="inline-action">
                            <input type="hidden" name="action" value="mark">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <button class="btn-small btn-mark" type="submit">Mark</button>
                        </form>
                        {% endif %}

                        <!-- QR Code -->
                        <button type="button" class="btn-small btn-qr"
                            onclick="showQR('{{ row.id }}', '{{ row.name }}', '{{ row.burger }}')">QR</button>

                        <!-- Save edit — tertiary/ghost -->
                        <button type="submit" form="edit-{{ row.id }}" class="btn-small btn-save-ghost">Save</button>

                        <!-- Delete — icon button -->
                        <form method="POST" class="inline-action">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <button class="btn-small btn-delete-icon" type="submit"
                                onclick="return confirm('Delete this user?')" title="Delete">&times;</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        </div>

        <div class="actions-bar">
            <a class="btn btn-small" href="/">Back to check-in</a>
            <form method="POST" class="inline-action">
                <input type="hidden" name="action" value="reset_all">
                <button class="btn-small btn-danger" type="submit"
                    onclick="return confirm('Reset ALL entries to Waiting?')">Reset all</button>
            </form>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="qr-modal-overlay" onclick="closeQR(event)">
        <div class="qr-modal">
            <h2 id="qr-modal-title"></h2>
            <p id="qr-modal-burger" class="qr-modal-burger"></p>
            <div id="qr-code-container"></div>
            <div class="qr-modal-actions">
                <button class="btn btn-small btn-download" onclick="downloadQR()">Download PNG</button>
                <button class="btn btn-small" onclick="closeQR()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentUserName = '';

        function showQR(userId, userName, userBurger) {
            currentUserName = userName;
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qr-code-container');
            document.getElementById('qr-modal-title').textContent = userName;
            document.getElementById('qr-modal-burger').textContent = userBurger;

            container.innerHTML = '';
            new QRCode(container, {
                text: String(userId),
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff'
            });

            modal.classList.add('active');
        }

        function closeQR(event) {
            if (event && event.target !== document.getElementById('qr-modal')) return;
            document.getElementById('qr-modal').classList.remove('active');
        }

        function downloadQR() {
            const src = document.querySelector('#qr-code-container canvas');
            if (!src) return;
            const border = 32;
            const out = document.createElement('canvas');
            out.width = src.width + border * 2;
            out.height = src.height + border * 2;
            const ctx = out.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, out.width, out.height);
            ctx.drawImage(src, border, border);
            const a = document.createElement('a');
            a.href = out.toDataURL('image/png');
            a.download = 'qr-' + currentUserName.replace(/[^a-zA-Z0-9]/g, '_') + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
