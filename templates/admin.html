<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body class="dashboard-body">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="sidebar-logo">
                    <img src="{{ url_for('static', filename='img/Logo_Branco.png') }}" alt="Logo">
                </div>
                <nav class="sidebar-nav">
                    <a href="#" class="nav-link active" data-section="section-overview">Overview</a>
                    <a href="#" class="nav-link" data-section="section-guests">Convidados</a>
                    <a href="#" class="nav-link" data-section="section-add">Adicionar</a>
                </nav>
            </div>
            <div class="sidebar-footer">
                <a class="sidebar-btn" href="/">&#8592; Back to check-in</a>
                <form method="POST" class="inline-action">
                    <input type="hidden" name="action" value="reset_all">
                    <button class="sidebar-btn sidebar-btn-danger" type="submit"
                        onclick="return confirm('Reset ALL entries to Waiting?')">Reset all</button>
                </form>
                <div class="sidebar-copyright">
                    Junior Data Consulting<br>&copy;2026 all rights reserved
                </div>
            </div>
        </aside>

        <!-- Mobile top bar -->
        <header class="mobile-topbar">
            <img src="{{ url_for('static', filename='img/Logo_Branco.png') }}" alt="Logo" class="mobile-logo">
            <nav class="mobile-nav">
                <a href="#" class="nav-link active" data-section="section-overview">Overview</a>
                <a href="#" class="nav-link" data-section="section-guests">Convidados</a>
                <a href="#" class="nav-link" data-section="section-add">Adicionar</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <div id="section-overview" class="section active">
                <h1>Overview</h1>
                <p class="section-subtitle">Resumo do evento</p>

                {% if message %}
                <div class="message {{ msg_class }}">{{ message }}</div>
                {% endif %}

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-num">{{ total }}</div>
                        <div class="kpi-label">Total</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-num">{{ picked }}</div>
                        <div class="kpi-label">Levantados</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-num">{{ remaining }}</div>
                        <div class="kpi-label">Restantes</div>
                    </div>
                </div>
            </div>

            <!-- Guests Section -->
            <div id="section-guests" class="section">
                <h1>Convidados</h1>
                <p class="section-subtitle">Gerir convidados e pedidos</p>

                {% if message %}
                <div class="message {{ msg_class }}">{{ message }}</div>
                {% endif %}

                <!-- Search bar -->
                <input type="text" id="guest-search" class="search-bar" placeholder="Procurar convidado...">

                <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome</th>
                            <th>Burger</th>
                            <th>Estado</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in rows %}
                        <tr id="row-{{ row.id }}">
                            <td>{{ loop.index }}</td>

                            <!-- Inline edit form -->
                            <td>
                                <form method="POST" class="edit-form" id="edit-{{ row.id }}">
                                    <input type="hidden" name="action" value="edit">
                                    <input type="hidden" name="user_id" value="{{ row.id }}">
                                    <input type="text" name="edit_name" value="{{ row.name }}" class="inline-input">
                            </td>
                            <td>
                                    <input type="text" name="edit_burger" value="{{ row.burger }}" class="inline-input">
                                </form>
                            </td>

                            <td>
                                {% if row.received %}
                                    <span class="status-yes">Levantado</span>
                                {% else %}
                                    <span class="status-no">Espera</span>
                                {% endif %}
                            </td>
                            <td class="action-cell">
                                {% if row.received %}
                                <form method="POST" class="inline-action">
                                    <input type="hidden" name="action" value="reset">
                                    <input type="hidden" name="user_id" value="{{ row.id }}">
                                    <button class="btn-small btn-danger" type="submit">Reset</button>
                                </form>
                                {% else %}
                                <form method="POST" class="inline-action">
                                    <input type="hidden" name="action" value="mark">
                                    <input type="hidden" name="user_id" value="{{ row.id }}">
                                    <button class="btn-small btn-mark" type="submit">Marcar</button>
                                </form>
                                {% endif %}

                                <button type="button" class="btn-small btn-qr"
                                    onclick="showQR('{{ row.id }}', '{{ row.name }}', '{{ row.burger }}')">QR</button>

                                <button type="submit" form="edit-{{ row.id }}" class="btn-small btn-save-ghost">Guardar</button>

                                <form method="POST" class="inline-action">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="user_id" value="{{ row.id }}">
                                    <button class="btn-small btn-delete-icon" type="submit"
                                        onclick="return confirm('Apagar este convidado?')" title="Apagar">&times;</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>

            <!-- Add Section -->
            <div id="section-add" class="section">
                <h1>Adicionar</h1>
                <p class="section-subtitle">Adicionar convidados manualmente ou por ficheiro Excel</p>

                {% if message %}
                <div class="message {{ msg_class }}">{{ message }}</div>
                {% endif %}

                <!-- Manual add -->
                <div class="add-form">
                    <h2>Adicionar Convidado</h2>
                    <form method="POST" class="inline-form">
                        <input type="hidden" name="action" value="add">
                        <input type="text" name="new_name" placeholder="Nome" required>
                        <input type="text" name="new_burger" placeholder="Burger" required>
                        <button class="btn-small" type="submit">Adicionar</button>
                    </form>
                </div>

                <!-- Excel import -->
                <div class="import-section">
                    <h2>Importar de Excel</h2>
                    <form method="POST" enctype="multipart/form-data" class="import-form">
                        <input type="hidden" name="action" value="import_excel">
                        <input type="file" name="excel_file" accept=".xlsx,.xls">
                        <p class="upload-help">O ficheiro deve ter coluna A = Nome, coluna B = Burger</p>
                        <button class="btn-small" type="submit">Importar</button>
                    </form>
                </div>
            </div>

            <!-- Footer -->
            <footer class="main-footer">
                Junior Data Consulting &mdash; &copy;2026 all rights reserved
            </footer>
        </main>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="qr-modal-overlay" onclick="closeQR(event)">
        <div class="qr-modal">
            <h2 id="qr-modal-title"></h2>
            <p id="qr-modal-burger" class="qr-modal-burger"></p>
            <div id="qr-code-container"></div>
            <div class="qr-modal-actions">
                <button class="btn btn-small btn-download" onclick="downloadQR()">Download PNG</button>
                <button class="btn btn-small" onclick="closeQR()">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let currentUserName = '';

        /* ---------- Section switching ---------- */
        document.querySelectorAll('.nav-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var target = this.getAttribute('data-section');

                // Update all nav links (both sidebar and mobile)
                document.querySelectorAll('.nav-link').forEach(function(l) {
                    l.classList.toggle('active', l.getAttribute('data-section') === target);
                });

                // Toggle sections
                document.querySelectorAll('.section').forEach(function(s) {
                    s.classList.toggle('active', s.id === target);
                });
            });
        });

        /* ---------- QR Code ---------- */
        function showQR(userId, userName, userBurger) {
            currentUserName = userName;
            var modal = document.getElementById('qr-modal');
            var container = document.getElementById('qr-code-container');
            document.getElementById('qr-modal-title').textContent = userName;
            document.getElementById('qr-modal-burger').textContent = userBurger;

            container.innerHTML = '';
            new QRCode(container, {
                text: String(userId),
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff'
            });

            modal.classList.add('active');
        }

        function closeQR(event) {
            if (event && event.target !== document.getElementById('qr-modal')) return;
            document.getElementById('qr-modal').classList.remove('active');
        }

        function downloadQR() {
            var src = document.querySelector('#qr-code-container canvas');
            if (!src) return;
            var border = 32;
            var out = document.createElement('canvas');
            out.width = src.width + border * 2;
            out.height = src.height + border * 2;
            var ctx = out.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, out.width, out.height);
            ctx.drawImage(src, border, border);
            var a = document.createElement('a');
            a.href = out.toDataURL('image/png');
            a.download = 'qr-' + currentUserName.replace(/[^a-zA-Z0-9]/g, '_') + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /* ---------- Guest search ---------- */
        (function() {
            var searchInput = document.getElementById('guest-search');
            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                var query = this.value.toLowerCase().trim();
                var rows = document.querySelectorAll('#section-guests tbody tr');
                var firstMatch = null;

                rows.forEach(function(row) {
                    // Name is in the second cell (index 1)
                    var nameInput = row.querySelector('input[name="edit_name"]');
                    var name = nameInput ? nameInput.value.toLowerCase() : '';

                    if (query === '' || name.indexOf(query) !== -1) {
                        row.style.display = '';
                        if (query !== '' && !firstMatch) {
                            firstMatch = row;
                        }
                    } else {
                        row.style.display = 'none';
                    }
                });

                if (firstMatch) {
                    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstMatch.classList.add('search-highlight');
                    setTimeout(function() {
                        firstMatch.classList.remove('search-highlight');
                    }, 1000);
                }
            });
        })();
    </script>
</body>
</html>
